<?xml version = "1.0" encoding="ISO-8859-1" ?>
<!-- 
 * OpenWMS, the open Warehouse Management System
 * 
 * Distributable under LGPL license.
 * See terms of license at gnu.org.
-->
<project xmlns:ivy="antlib:org.apache.ivy.ant" name="OpenWMS-Flex-GraniteDS" default="all" basedir=".">
    <tstamp>
        <format property="TODAY" pattern="yyyy-MM-dd HH:mm:ss 'GMT'Z" />
    </tstamp>

    <property environment="env" />
    <property file="build.properties" />

    <path id="class.path">
        <fileset dir="${openwms_common.dist.dir}">
            <include name="*.jar" />
        </fileset>
        <fileset dir="${deps.dir}/build">
            <include name="*.jar" />
        </fileset>
    </path>

    <target name="deps">
        <echo message="************************************************" />
        <echo message="Resolve dependencies..." />
        <echo message="************************************************" />
        <path id="ivy.path">
			<fileset dir="${lib.dir}/ivy" includes="**/*.jar" />
		</path>
        <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.path" />
        <ivy:configure file="${ivy.settings.file}" />
        <ivy:resolve file="${ivy.dep.file}" conf="build, test" />
        <ivy:retrieve pattern="${deps.dir}/[conf]/[artifact]-[revision].[ext]"/>
    </target>

    <target name="deps-clean">
        <echo message="************************************************" />
        <echo message="Clear dependencies..." />
        <echo message="************************************************" />
        <delete>
            <fileset dir="${deps.test.dir}">
                <include name="**/*" />
            </fileset>
        </delete>
        <delete>
            <fileset dir="${deps.build.dir}">
                <include name="**/*" />
            </fileset>
        </delete>
    </target>

    <target name="initialize">
        <echo message="************************************************" />
        <echo message="Remove and create directories..." />
        <echo message="************************************************" />
        <mkdir dir="${dist.dir}" />
        <mkdir dir="${build.main.dir}" />
    </target>

    <target name="compile" depends="initialize, deps">
        <echo message="************************************************" />
        <echo message="Compile sources in ${src.dir}..." />
        <echo message="************************************************" />
        <javac destdir="${build.main.dir}" classpathref="class.path" debug="on" deprecation="on">
            <src path="${src.dir}" />
        </javac>
    </target>
	
    <!-- Declare Flex Ant tasks (such as mxmlc used below) -->
    <taskdef resource="flexTasks.tasks" classpath="${FLEX_HOME}/ant/lib/flexTasks.jar" />

    <!-- Compile MXML source code to SWF -->
    <target name="mxmlc">
        <mxmlc
            file="src/main.mxml"
            output="WebContent/main.swf"
            services="WebContent/WEB-INF/flex/services-config.xml"
            context-root="OpenWMS">
            <source-path path-element="src"/>
            <compiler.include-libraries dir="lib" append="true">
                <include name="*.swc" />
            </compiler.include-libraries>
        </mxmlc>
    </target>
	
	<target name="copy-libs">
        <delete>
            <fileset dir="WebContent/WEB-INF/lib">
                <include name="**/*" />
            </fileset>
        </delete>
		<copy file="${openwms_common.jar}" todir="WebContent/WEB-INF/lib" />
		<copy file="${openwms_tms.jar}" todir="WebContent/WEB-INF/lib" />
		<copy file="${openwms_services.jar}" todir="WebContent/WEB-INF/lib" />
		<copy file="${openwms_service-impl.jar}" todir="WebContent/WEB-INF/lib" />
		<copy todir="WebContent/WEB-INF/lib">
			<fileset dir="${deps.build.dir}" id="id">
    			<exclude name="*-sources*.jar"/>
            	<include name="com.springsource.org.postgresql.jdbc3*.jar"/>
			</fileset>
			<fileset dir="${deps.test.dir}" id="id">
    			<exclude name="*-sources*.jar"/>
    			<include name="org.springframework.web*.jar"/>
    			<include name="org.springframework.beans*.jar"/>
    			<include name="org.springframework.instrument.classloading*.jar"/>
    			<include name="org.springframework.jdbc*.jar"/>
    			<include name="org.springframework.context*.jar"/>
        		<include name="org.springframework.transaction*.jar"/>
        		<include name="org.springframework.orm*.jar"/>
            	<include name="org.springframework.aop*.jar"/>
            	<include name="org.springframework.core*.jar"/>
            	<include name="com.springsource.org.aspectj.runtime*.jar"/>
            	<include name="com.springsource.net.sf.cglib*.jar"/>
            	<include name="com.springsource.javax.persistence*.jar"/>
                <include name="com.springsource.org.apache.log4j*.jar"/>
            	<include name="com.springsource.org.hsqldb*.jar"/>
            	<include name="com.springsource.org.apache.commons.collections*.jar"/>
    			<include name="com.springsource.org.apache.commons.logging*.jar"/>
            	<include name="com.springsource.org.aopalliance*.jar"/>
			</fileset>
			<fileset dir="${lib.dir}">
				<include name="granite-spring.jar"/>
				<include name="granite-hibernate.jar"/>
				<include name="granite.jar"/>
			</fileset>
		</copy>
		
	</target>

	<target name="war" depends="copy-libs">
        <echo message="************************************************" />
        <echo message="Create war file ${dist.dir}/${war.file}..." />
        <echo message="************************************************" />
        <war destfile="${dist.dir}/${war.file}" webxml="WebContent/WEB-INF/web.xml">
            <fileset dir="WebContent" />
            <manifest>
                <attribute name="Main-Class" value="" />
                <attribute name="Class-Path" value="." />
            </manifest>
        </war>
    </target>

    <target name="jar-osgi">
        <echo message="************************************************" />
        <echo message="Create OSGi compliant jar file ${dist.dir}/${osgi-jar.file}..." />
        <echo message="************************************************" />
        <jar destfile="${dist.dir}/${osgi-jar.file}" manifest="${src.meta-inf.dir}/MANIFEST.MF">
            <fileset dir="${build.main.dir}" />
        </jar>
    </target>

    <target name="clean">
        <echo message="************************************************" />
        <echo message="Clean" />
        <echo message="************************************************" />
        <delete dir="${build.main.dir}" />
    </target>

    <target name="build" depends="clean, initialize, compile, war">
        <echo message="************************************************" />
        <echo message="Building..." />
        <echo message="************************************************" />
    </target>
    <target name="build-osgi" depends="clean, initialize, compile, jar-osgi">
        <echo message="************************************************" />
        <echo message="Building OSGi bundle..." />
        <echo message="************************************************" />
    </target>
    <target name="all" depends="build, build-osgi">
        <echo message="************************************************" />
        <echo message="Building nightly build" />
        <echo message="************************************************" />
    </target>
</project>